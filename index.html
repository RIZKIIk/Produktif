<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LevelUp Tracker - Jadwal Sholat & Produktivitas</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%236d28d9%22/><text x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22white%22 text-anchor=%22middle%22>LU</text></svg>">
  <style>
    /* ======================
       GLOBAL STYLES & VARIABLES
       ====================== */
    :root {
      --bg-primary: #0a0f1d;
      --bg-secondary: #0e1629;
      --bg-tertiary: #131e36;
      --card-bg: #152238;
      --border-color: rgba(255, 255, 255, 0.08);
      --text-primary: #f0f7ff;
      --text-secondary: #a3b3cc;
      --text-tertiary: #7a8ca5;
      --accent-violet: #7c3aed;
      --accent-indigo: #6366f1;
      --accent-blue: #3b82f6;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #ef4444;
      --accent-cyan: #06b6d4;
      --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.15);
      --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.25);
      --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.4);
      --transition: all 0.35s cubic-bezier(0.165, 0.84, 0.44, 1);
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 9999px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      font-size: 16px;
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      font-family: 'Segoe UI', system-ui, -apple-system, Inter, Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.08) 0%, transparent 25%),
        radial-gradient(circle at 90% 80%, rgba(124, 58, 237, 0.07) 0%, transparent 30%),
        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
      z-index: -2;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 10;
    }

    /* ======================
       NOTIFICATION SYSTEM
       ====================== */
    .notification-system {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      pointer-events: none;
    }

    .notification-bar {
      background: linear-gradient(90deg, var(--accent-violet), var(--accent-indigo));
      color: white;
      padding: 14px 28px;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 600;
      font-size: 1.05rem;
      margin: 8px 0;
      transform: translateY(-150%);
      transition: var(--transition);
      pointer-events: all;
      min-width: 300px;
      max-width: 90%;
      animation: pulse-border 4s infinite;
    }

    @keyframes pulse-border {
      0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
      70% { box-shadow: 0 0 0 12px rgba(124, 58, 237, 0); }
      100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
    }

    .notification-bar.show {
      transform: translateY(0);
    }

    .notification-icon {
      font-size: 1.8rem;
      min-width: 32px;
      text-align: center;
    }

    .notification-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .notification-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-time {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 12px;
      border-radius: var(--radius-full);
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: -0.5px;
    }

    .notification-actions {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }

    .notification-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .notification-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    .notification-btn.snooze {
      background: rgba(255, 255, 255, 0.1);
    }

    .notification-close {
      background: none;
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      transition: var(--transition);
      flex-shrink: 0;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .notification-urgent {
      background: linear-gradient(90deg, var(--accent-rose), var(--accent-amber));
      animation: pulse-urgent 2s infinite;
    }

    @keyframes pulse-urgent {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* ======================
       HEADER STYLES
       ====================== */
    header {
      text-align: center;
      padding: 24px 16px 16px;
      position: relative;
      margin-bottom: 24px;
    }

    .header-content {
      max-width: 800px;
      margin: 0 auto;
    }

    .app-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .logo-icon {
      width: 64px;
      height: 64px;
      border-radius: 24px;
      background: linear-gradient(135deg, var(--accent-violet), var(--accent-indigo));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
      position: relative;
      overflow: hidden;
    }

    .logo-icon::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: rotate(45deg);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: rotate(45deg) translateX(-100%); }
      100% { transform: rotate(45deg) translateX(100%); }
    }

    .app-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(to right, var(--accent-violet), var(--accent-indigo), var(--accent-blue));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -1px;
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .app-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto 24px;
      line-height: 1.5;
    }

    .progress-display {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      max-width: 600px;
      margin: 24px auto 0;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .progress-title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-value {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(to right, var(--accent-violet), var(--accent-indigo));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      line-height: 1;
    }

    .progress-bar-container {
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-full);
      height: 16px;
      overflow: hidden;
      margin-top: 12px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-violet), var(--accent-indigo));
      border-radius: var(--radius-full);
      width: 0%;
      transition: width 1.2s cubic-bezier(0.19, 1, 0.22, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: progress-shine 2s infinite;
    }

    @keyframes progress-shine {
      0% { transform: translateX(-100%); opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 0.95rem;
      color: var(--text-tertiary);
    }

    .progress-count {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ======================
       DAY SELECTOR
       ====================== */
    .days-selector {
      display: flex;
      gap: 8px;
      padding: 12px 8px;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
      margin: 24px 0 28px;
      justify-content: center;
    }

    .days-selector::-webkit-scrollbar {
      height: 6px;
    }

    .days-selector::-webkit-scrollbar-track {
      background: transparent;
    }

    .days-selector::-webkit-scrollbar-thumb {
      background-color: var(--border-color);
      border-radius: var(--radius-full);
    }

    .day-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: var(--radius-full);
      font-weight: 500;
      font-size: 1.05rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      min-width: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .day-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .day-btn.active {
      background: linear-gradient(90deg, var(--accent-violet), var(--accent-indigo));
      color: white;
      border: none;
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.45);
      transform: translateY(-3px);
    }

    .day-btn.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }

    .day-btn.today {
      position: relative;
    }

    .day-btn.today::before {
      content: '‚Ä¢';
      position: absolute;
      top: -6px;
      font-size: 24px;
      color: var(--accent-emerald);
      line-height: 1;
    }

    /* ======================
       MAIN CONTENT GRID
       ====================== */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 28px;
      margin-bottom: 32px;
    }

    @media (min-width: 1024px) {
      .main-grid {
        grid-template-columns: 380px 1fr;
      }
    }

    /* ======================
       CARDS
       ====================== */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      padding: 24px;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .prayer-card .card-icon {
      background: rgba(124, 58, 237, 0.15);
      color: var(--accent-violet);
    }

    .stats-card .card-icon {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
    }

    .kpi-card .card-icon {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
    }

    .settings-card .card-icon {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-amber);
    }

    /* ======================
       PRAYER TIMES SECTION
       ====================== */
    .location-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-md);
      margin: 16px 0;
      font-size: 0.95rem;
    }

    .location-icon {
      font-size: 1.3rem;
      color: var(--accent-indigo);
    }

    .location-name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .location-loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-tertiary);
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent-indigo);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .prayer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .prayer-item {
      text-align: center;
      padding: 14px 8px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.03);
      transition: var(--transition);
      border: 1px solid transparent;
    }

    .prayer-item.active {
      background: rgba(79, 70, 229, 0.15);
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
      transform: scale(1.03);
    }

    .prayer-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .prayer-time {
      font-weight: 700;
      font-size: 1.4rem;
      background: linear-gradient(to right, var(--accent-violet), var(--accent-indigo));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .prayer-item.active .prayer-time {
      font-size: 1.6rem;
      background: linear-gradient(to right, white, var(--text-primary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .city-selector {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .city-selector label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .city-selector select {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-size: 1rem;
      cursor: pointer;
    }

    .city-selector select:focus {
      outline: none;
      border-color: var(--accent-indigo);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* ======================
       STATS SECTION
       ====================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .stat-item {
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.03);
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(to right, var(--accent-violet), var(--accent-indigo));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .stat-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin-top: 6px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .trend-up {
      color: var(--accent-emerald);
    }

    .trend-down {
      color: var(--accent-rose);
    }

    /* ======================
       KPI SECTION
       ====================== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .kpi-item {
      padding: 16px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.03);
      text-align: center;
    }

    .kpi-label {
      font-size: 0.95rem;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 1.7rem;
      font-weight: 700;
      background: linear-gradient(to right, var(--accent-violet), var(--accent-indigo));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* ======================
       SETTINGS SECTION
       ====================== */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.03);
    }

    .setting-label {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .setting-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.1);
      transition: var(--transition);
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--accent-indigo);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    /* ======================
       BUTTONS
       ====================== */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 14px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 1.05rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border: none;
      flex: 1;
      min-width: 160px;
    }

    @media (min-width: 480px) {
      .btn {
        flex: none;
      }
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent-violet), var(--accent-indigo));
      color: white;
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.55);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .btn-export {
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-indigo));
      color: white;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
    }

    .btn-export:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
    }

    .btn-warning {
      background: linear-gradient(90deg, var(--accent-amber), #d97706);
      color: white;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.45);
    }

    .btn-success {
      background: linear-gradient(90deg, var(--accent-emerald), #0ca678);
      color: white;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.45);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ======================
       TASKS SECTION
       ====================== */
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .task-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      padding: 20px;
      display: flex;
      align-items: flex-start;
      gap: 20px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .task-card:hover {
      transform: translateX(8px);
      border-color: rgba(255, 255, 255, 0.12);
      box-shadow: var(--shadow-md);
    }

    .task-card.completed {
      opacity: 0.85;
      border-color: rgba(16, 185, 129, 0.3);
    }

    .task-card.completed::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      background: var(--accent-emerald);
    }

    .task-icon {
      width: 60px;
      height: 60px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 2;
    }

    .task-icon.prayer {
      background: rgba(124, 58, 237, 0.15);
      color: var(--accent-violet);
      border-color: rgba(124, 58, 237, 0.3);
    }

    .task-icon.skill {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .task-icon.physique {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .task-icon.health {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-amber);
      border-color: rgba(245, 158, 11, 0.3);
    }

    .task-icon.work {
      background: rgba(236, 72, 153, 0.15);
      color: #ec4899;
      border-color: rgba(236, 72, 153, 0.3);
    }

    .task-icon.family {
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-indigo);
      border-color: rgba(139, 92, 246, 0.3);
    }

    .task-icon.default {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
      border-color: rgba(107, 114, 128, 0.3);
    }

    .task-card.completed .task-icon {
      background: rgba(16, 185, 129, 0.2) !important;
      color: var(--accent-emerald) !important;
      border-color: rgba(16, 185, 129, 0.5) !important;
    }

    .task-card.completed .task-icon::after {
      content: '‚úì';
      position: absolute;
      font-size: 1.6rem;
      font-weight: bold;
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .task-title {
      font-size: 1.35rem;
      font-weight: 700;
      margin-right: 16px;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--text-tertiary);
    }

    .task-time {
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-full);
      padding: 4px 16px;
      font-weight: 700;
      font-size: 1.15rem;
      min-width: 70px;
      text-align: center;
      flex-shrink: 0;
    }

    .task-card.completed .task-time {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
    }

    .task-desc {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .task-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 8px;
    }

    .status-upcoming {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
    }

    .status-due {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-amber);
    }

    .status-overdue {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-rose);
    }

    .status-completed {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
    }

    .task-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .task-btn {
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .task-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .task-btn.complete {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .task-btn.complete:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      margin-top: 28px;
      flex-wrap: wrap;
    }

    /* ======================
       FOOTER
       ====================== */
    footer {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-tertiary);
      font-size: 0.95rem;
      border-top: 1px solid var(--border-color);
      margin-top: 16px;
    }

    footer a {
      color: var(--accent-indigo);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
    }

    footer a:hover {
      color: var(--accent-violet);
      text-decoration: underline;
    }

    /* ======================
       RESPONSIVE DESIGN
       ====================== */
    @media (max-width: 768px) {
      .app-title {
        font-size: 2.1rem;
      }
      
      .progress-value {
        font-size: 2.3rem;
      }
      
      .day-btn {
        padding: 8px 14px;
        font-size: 0.95rem;
        min-width: 65px;
      }
      
      .card {
        padding: 20px;
      }
      
      .task-card {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      
      .task-header {
        flex-direction: column;
        align-items: center;
      }
      
      .task-time {
        width: 100%;
        margin-top: 12px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .app-logo {
        gap: 10px;
      }
      
      .logo-icon {
        width: 50px;
        height: 50px;
        font-size: 22px;
      }
      
      .app-title {
        font-size: 1.9rem;
      }
      
      .notification-bar {
        padding: 12px 20px;
        font-size: 0.95rem;
        min-width: auto;
        width: 92%;
      }
      
      .notification-title {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .prayer-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .stats-grid, .kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ======================
       ANIMATIONS
       ====================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }

    /* ======================
       ACCESSIBILITY
       ====================== */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        animation: none !important;
      }
    }

    button:focus, .day-btn:focus, .task-card:focus {
      outline: 2px solid var(--accent-indigo);
      outline-offset: 2px;
    }

    /* ======================
       BADGES & STATUS INDICATORS
       ====================== */
    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-emerald);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-amber);
    }

    .badge-error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-rose);
    }

    /* ======================
       SKELETON LOADING
       ====================== */
    .skeleton {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: var(--radius-md);
      min-height: 20px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ======================
       TOAST NOTIFICATIONS
       ====================== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
      max-width: 400px;
      pointer-events: none;
    }

    .toast {
      background: var(--card-bg);
      border-left: 4px solid var(--accent-indigo);
      color: var(--text-primary);
      padding: 16px 24px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(400px);
      transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1);
      pointer-events: all;
      min-width: 300px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left-color: var(--accent-emerald);
    }

    .toast.error {
      border-left-color: var(--accent-rose);
    }

    .toast.warning {
      border-left-color: var(--accent-amber);
    }

    .toast-icon {
      font-size: 1.5rem;
      min-width: 24px;
    }

    /* ======================
       OFFLINE INDICATOR
       ====================== */
    .offline-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-rose);
      color: white;
      padding: 8px 24px;
      border-radius: var(--radius-full);
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      z-index: 1000;
      display: none;
      animation: pulse-border 2s infinite;
    }

    .offline-indicator.show {
      display: block;
    }

    /* ======================
       MODAL STYLES
       ====================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 500px;
      padding: 24px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--accent-rose);
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* ======================
       TABS
       ====================== */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .tab-btn.active {
      color: var(--accent-indigo);
      background: rgba(99, 102, 241, 0.1);
      border-bottom: 3px solid var(--accent-indigo);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ======================
       CHART STYLES
       ====================== */
    .chart-container {
      height: 250px;
      margin-top: 16px;
      position: relative;
    }

    /* ======================
       SEARCH & FILTER
       ====================== */
    .search-container {
      margin-bottom: 20px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 20px 12px 40px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-indigo);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Notification System -->
  <div class="notification-system">
    <div class="notification-bar" id="mainNotification">
      <div class="notification-icon">‚è∞</div>
      <div class="notification-content">
        <div class="notification-title">
          <span id="notificationTitle">Memuat jadwal berikutnya...</span>
          <span class="notification-time" id="notificationTime"></span>
        </div>
        <div class="notification-actions">
          <button class="notification-btn complete">Selesaikan</button>
          <button class="notification-btn snooze">Tunda 15 Menit</button>
        </div>
      </div>
      <button class="notification-close" id="notificationClose" aria-label="Tutup notifikasi">√ó</button>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">‚ö†Ô∏è Mode Offline - Menggunakan data terakhir</div>

  <!-- Main App -->
  <div class="app-container">
    <header>
      <div class="header-content">
        <div class="app-logo">
          <div class="logo-icon">üöÄ</div>
          <h1 class="app-title">LEVEL UP TRACKER</h1>
        </div>
        <p class="app-subtitle">Integrasi Jadwal Sholat dengan Manajemen Produktivitas Harian - Optimalkan Waktu Ibadah & Aktivitas</p>
        
        <div class="progress-display fade-in">
          <div class="progress-header">
            <div class="progress-title">
              <span>üìä</span>
              <span>Progress Hari Ini</span>
            </div>
            <div class="progress-value" id="score">0%</div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="progress-stats">
            <div>Selesai: <span class="progress-count" id="doneCount">0</span>/<span class="progress-count" id="totalCount">0</span></div>
            <div>Hari ini: <span id="currentDate">-</span></div>
          </div>
        </div>
      </div>
      
      <div class="days-selector" id="days" role="tablist" aria-label="Pilih Hari"></div>
    </header>

    <div class="main-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Prayer Times Card -->
        <div class="card prayer-card fade-in">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon">üïå</div>
              <span>Waktu Sholat Hari Ini</span>
            </div>
            <button class="btn btn-primary" id="refreshTimes">
              <span id="refreshIcon">‚ü≥</span> Perbarui
            </button>
          </div>
          
          <div class="location-display">
            <div class="location-icon">üìç</div>
            <div class="location-name">
              <span>Lokasi:</span>
              <span id="locText" class="location-loading">
                <span class="loading-spinner"></span> Mendeteksi lokasi...
              </span>
            </div>
          </div>
          
          <div class="city-selector">
            <label for="citySelect">Pilih Kota (Fallback):</label>
            <select id="citySelect">
              <option value="jakarta">Jakarta</option>
              <option value="malang" selected>Malang</option>
              <option value="bandung">Bandung</option>
              <option value="surabaya">Surabaya</option>
              <option value="yogyakarta">Yogyakarta</option>
              <option value="medan">Medan</option>
              <option value="makassar">Makassar</option>
            </select>
          </div>
          
          <div class="prayer-grid" id="prayerTimesGrid">
            <!-- Prayer times will be inserted here -->
            <div class="prayer-item skeleton" style="height: 70px;"></div>
            <div class="prayer-item skeleton" style="height: 70px;"></div>
            <div class="prayer-item skeleton" style="height: 70px;"></div>
            <div class="prayer-item skeleton" style="height: 70px;"></div>
            <div class="prayer-item skeleton" style="height: 70px;"></div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-export" id="exportICS">
              <span>üìÖ</span> Google Calendar
            </button>
            <button class="btn btn-export" id="downloadCSV">
              <span>üìä</span> Download CSV
            </button>
          </div>
        </div>
        
        <!-- Statistics Card -->
        <div class="card stats-card fade-in">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon">üìà</div>
              <span>Statistik Mingguan</span>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Rata-rata Harian</div>
              <div class="stat-value">78%</div>
              <div class="stat-trend trend-up">‚Üë 12%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Sholat Tepat Waktu</div>
              <div class="stat-value">92%</div>
              <div class="stat-trend trend-up">‚Üë 8%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Skill Development</div>
              <div class="stat-value">12.5j</div>
              <div class="stat-trend trend-down">‚Üì 1.5j</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Konsistensi</div>
              <div class="stat-value">86%</div>
              <div class="stat-trend trend-up">‚Üë 5 hari</div>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="weeklyChart"></canvas>
          </div>
        </div>
        
        <!-- Settings Card -->
        <div class="card settings-card fade-in">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon">‚öôÔ∏è</div>
              <span>Pengaturan Notifikasi</span>
            </div>
          </div>
          
          <div class="settings-grid">
            <div class="setting-item">
              <span class="setting-label">Notifikasi Sholat</span>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="prayerNotificationToggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-item">
              <span class="setting-label">Notifikasi Tugas</span>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="taskNotificationToggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-item">
              <span class="setting-label">Durasi Tunda (menit)</span>
              <div class="setting-control">
                <select id="snoozeDuration">
                  <option value="5">5 Menit</option>
                  <option value="10">10 Menit</option>
                  <option value="15" selected>15 Menit</option>
                  <option value="30">30 Menit</option>
                  <option value="60">1 Jam</option>
                </select>
              </div>
            </div>
            <div class="setting-item">
              <span class="setting-label">Mode Gelap</span>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="darkModeToggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div class="right-column">
        <div class="tasks-header">
          <div class="section-title">
            <span>‚úÖ</span>
            <span>Daftar Tugas Hari Ini</span>
          </div>
          <div class="btn-group">
            <button class="btn btn-warning" id="resetDay">
              <span>‚Ü∫</span> Reset Hari Ini
            </button>
            <button class="btn btn-success" id="completeAll">
              <span>‚úì</span> Selesaikan Semua
            </button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab-btn active" data-tab="today">Hari Ini</button>
          <button class="tab-btn" data-tab="week">Minggu Ini</button>
          <button class="tab-btn" data-tab="history">Riwayat</button>
        </div>
        
        <div class="search-container">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" id="taskSearch" placeholder="Cari tugas...">
        </div>
        
        <div class="tasks-container" id="tasksList" aria-live="polite">
          <!-- Tasks will be inserted here -->
          <div class="task-card skeleton" style="height: 120px;"></div>
          <div class="task-card skeleton" style="height: 120px;"></div>
          <div class="task-card skeleton" style="height: 120px;"></div>
        </div>
      </div>
    </div>
    
    <footer>
      <p>LevelUp Tracker v3.0 ‚Ä¢ Data waktu sholat dari <a href="https://aladhan.com/api" target="_blank" rel="noopener noreferrer">Aladhan API</a> & <a href="https://nusantarasholat.com/api" target="_blank" rel="noopener noreferrer">Nusantarasholat API</a></p>
      <p style="margin-top: 8px;">Aplikasi ini 100% offline-capable. Semua data disimpan di perangkat Anda.</p>
      <p style="margin-top: 8px;">¬© 2026 LevelUp Tracker - Meningkatkan Produktivitas dengan Ketaatan</p>
    </footer>
  </div>

  <!-- Modal for Task Details -->
  <div class="modal" id="taskDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTaskTitle">Detail Tugas</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modalTaskDesc"></p>
        <div class="task-status" id="modalTaskStatus"></div>
        <div style="margin-top: 16px;">
          <strong>Jam:</strong> <span id="modalTaskTime"></span>
        </div>
        <div style="margin-top: 8px;">
          <strong>Kategori:</strong> <span id="modalTaskCategory"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeModalBtn">Tutup</button>
        <button class="btn btn-primary" id="completeTaskBtn">Tandai Selesai</button>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // MODULAR APPLICATION STRUCTURE
    // ======================
    
    // Core Application Module
    const LevelUpTracker = (function() {
      // Application state
      const state = {
        completed: {},
        selectedDay: new Date().getDay(),
        location: null,
        timings: null,
        notification: {
          visible: true,
          lastUpdated: null,
          snoozedUntil: null
        },
        settings: {
          defaultCity: 'malang',
          scheduleNotifications: true,
          prayerNotifications: true,
          taskNotifications: true,
          snoozeDuration: 15,
          darkMode: true
        },
        currentTaskId: null,
        weeklyData: [
          { day: 'Senin', progress: 75 },
          { day: 'Selasa', progress: 82 },
          { day: 'Rabu', progress: 90 },
          { day: 'Kamis', progress: 78 },
          { day: 'Jumat', progress: 85 },
          { day: 'Sabtu', progress: 92 },
          { day: 'Minggu', progress: 88 }
        ]
      };
      
      // DOM Elements Cache
      const elements = {
        days: document.getElementById('days'),
        tasksList: document.getElementById('tasksList'),
        prayerTimesGrid: document.getElementById('prayerTimesGrid'),
        locText: document.getElementById('locText'),
        refreshTimes: document.getElementById('refreshTimes'),
        refreshIcon: document.getElementById('refreshIcon'),
        exportICS: document.getElementById('exportICS'),
        downloadCSV: document.getElementById('downloadCSV'),
        resetDay: document.getElementById('resetDay'),
        completeAll: document.getElementById('completeAll'),
        score: document.getElementById('score'),
        doneCount: document.getElementById('doneCount'),
        totalCount: document.getElementById('totalCount'),
        progressBar: document.getElementById('progressBar'),
        currentDate: document.getElementById('currentDate'),
        mainNotification: document.getElementById('mainNotification'),
        notificationTitle: document.getElementById('notificationTitle'),
        notificationTime: document.getElementById('notificationTime'),
        notificationClose: document.getElementById('notificationClose'),
        toastContainer: document.getElementById('toastContainer'),
        offlineIndicator: document.getElementById('offlineIndicator'),
        citySelect: document.getElementById('citySelect'),
        prayerNotificationToggle: document.getElementById('prayerNotificationToggle'),
        taskNotificationToggle: document.getElementById('taskNotificationToggle'),
        snoozeDuration: document.getElementById('snoozeDuration'),
        darkModeToggle: document.getElementById('darkModeToggle'),
        taskSearch: document.getElementById('taskSearch'),
        tabBtns: document.querySelectorAll('.tab-btn'),
        taskDetailModal: document.getElementById('taskDetailModal'),
        closeModal: document.getElementById('closeModal'),
        closeModalBtn: document.getElementById('closeModalBtn'),
        completeTaskBtn: document.getElementById('completeTaskBtn'),
        modalTaskTitle: document.getElementById('modalTaskTitle'),
        modalTaskDesc: document.getElementById('modalTaskDesc'),
        modalTaskStatus: document.getElementById('modalTaskStatus'),
        modalTaskTime: document.getElementById('modalTaskTime'),
        modalTaskCategory: document.getElementById('modalTaskCategory')
      };
      
      // Constants
      const APP_VERSION = '3.0.0';
      const JAKARTA_LOCATION = { lat: -6.2088, lon: 106.8456, name: 'Jakarta' };
      const MALANG_LOCATION = { lat: -7.9797, lon: 112.6304, name: 'Malang' };
      const DEFAULT_FALLBACK_CITY = 'malang';
      
      // Fallback prayer times for major Indonesian cities (enhanced)
      const FALLBACK_PRAYER_TIMES = {
        jakarta: {
          Fajr: "04:30", Dhuhr: "12:00", Asr: "15:30", Maghrib: "18:00", Isha: "19:30",
          imsak: "04:15", sunrise: "05:45", midnight: "00:00"
        },
        malang: {
          Fajr: "04:15", Dhuhr: "11:45", Asr: "15:15", Maghrib: "17:45", Isha: "19:00",
          imsak: "04:00", sunrise: "05:30", midnight: "00:00"
        },
        bandung: {
          Fajr: "04:25", Dhuhr: "11:55", Asr: "15:25", Maghrib: "17:55", Isha: "19:10",
          imsak: "04:10", sunrise: "05:40", midnight: "00:00"
        },
        surabaya: {
          Fajr: "04:10", Dhuhr: "11:40", Asr: "15:10", Maghrib: "17:40", Isha: "18:55",
          imsak: "03:55", sunrise: "05:25", midnight: "00:00"
        },
        yogyakarta: {
          Fajr: "04:20", Dhuhr: "11:50", Asr: "15:20", Maghrib: "17:50", Isha: "19:05",
          imsak: "04:05", sunrise: "05:35", midnight: "00:00"
        },
        medan: {
          Fajr: "04:45", Dhuhr: "12:15", Asr: "15:45", Maghrib: "18:15", Isha: "19:30",
          imsak: "04:30", sunrise: "06:00", midnight: "00:00"
        },
        makassar: {
          Fajr: "04:35", Dhuhr: "12:10", Asr: "15:40", Maghrib: "18:10", Isha: "19:25",
          imsak: "04:20", sunrise: "05:55", midnight: "00:00"
        }
      };
      
      // Schedule data (enhanced with more categories and realistic times)
      const scheduleData = {
        weekend: [
          { id: 'w1', title: 'Bangun Pagi', desc: 'Bangun sebelum waktu Subuh untuk persiapan sholat', time: '04:00', type: 'health', priority: 'high' },
          { id: 'w2', title: 'Shalat Subuh', desc: 'Shalat berjamaah di masjid atau tepat waktu di rumah', time: '{SUBUH}', type: 'prayer', priority: 'critical' },
          { id: 'w3', title: 'Sarapan Sehat', desc: 'Menu seimbang dengan protein & serat untuk energi pagi', time: '06:30', type: 'health', priority: 'medium' },
          { id: 'w4', title: 'Skill Development', desc: 'Pelajari topik baru atau tingkatkan kemampuan', time: '09:00', type: 'skill', priority: 'high' },
          { id: 'w5', title: 'Olahraga Ringan', desc: 'Jalan kaki, yoga, atau stretching selama 30 menit', time: '10:30', type: 'physique', priority: 'medium' },
          { id: 'w6', title: 'Shalat Dzuhur', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{DZUHUR}', type: 'prayer', priority: 'critical' },
          { id: 'w7', title: 'Quality Time Keluarga', desc: 'Bersama keluarga tanpa gadget, berdiskusi atau bermain', time: '13:00', type: 'family', priority: 'high' },
          { id: 'w8', title: 'Shalat Ashar', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ASR}', type: 'prayer', priority: 'critical' },
          { id: 'w9', title: 'Refleksi Harian', desc: 'Evaluasi pencapaian hari ini dan rencana perbaikan', time: '16:30', type: 'mindfulness', priority: 'medium' },
          { id: 'w10', title: 'Shalat Maghrib', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{MAGHRIB}', type: 'prayer', priority: 'critical' },
          { id: 'w11', title: 'Makan Malam', desc: 'Menu sehat & porsi terkontrol, hindari makan berlebihan', time: '19:00', type: 'health', priority: 'medium' },
          { id: 'w12', title: 'Shalat Isya', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ISYA}', type: 'prayer', priority: 'critical' },
          { id: 'w13', title: 'Persiapan Esok', desc: 'Rencanakan jadwal dan persiapan untuk hari berikutnya', time: '20:30', type: 'planning', priority: 'medium' },
          { id: 'w14', title: 'Tidur Cukup', desc: 'Target 7-8 jam tidur malam untuk kesehatan optimal', time: '22:00', type: 'health', priority: 'high' }
        ],
        long: [
          { id: 'l1', title: 'Bangun Pagi', desc: 'Bangun sebelum waktu Subuh untuk persiapan sholat', time: '04:00', type: 'health', priority: 'high' },
          { id: 'l2', title: 'Shalat Subuh', desc: 'Shalat berjamaah di masjid atau tepat waktu di rumah', time: '{SUBUH}', type: 'prayer', priority: 'critical' },
          { id: 'l3', title: 'Sarapan Sehat', desc: 'Menu seimbang dengan protein & serat untuk energi pagi', time: '06:30', type: 'health', priority: 'medium' },
          { id: 'l4', title: 'Kerja/Sekolah', desc: 'Fokus pada tanggung jawab utama dengan produktivitas tinggi', time: '08:00', type: 'work', priority: 'high' },
          { id: 'l5', title: 'Skill Development', desc: 'Pelajari topik baru atau tingkatkan kemampuan profesional', time: '12:30', type: 'skill', priority: 'medium' },
          { id: 'l6', title: 'Shalat Dzuhur', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{DZUHUR}', type: 'prayer', priority: 'critical' },
          { id: 'l7', title: 'Olahraga Ringan', desc: 'Jalan kaki, yoga, atau stretching selama 30 menit', time: '14:00', type: 'physique', priority: 'medium' },
          { id: 'l8', title: 'Shalat Ashar', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ASR}', type: 'prayer', priority: 'critical' },
          { id: 'l9', title: 'Kerja/Sekolah', desc: 'Lanjutkan pekerjaan penting atau tugas sekolah', time: '16:00', type: 'work', priority: 'high' },
          { id: 'l10', title: 'Shalat Maghrib', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{MAGHRIB}', type: 'prayer', priority: 'critical' },
          { id: 'l11', title: 'Makan Malam', desc: 'Menu sehat & porsi terkontrol, hindari makan berlebihan', time: '19:00', type: 'health', priority: 'medium' },
          { id: 'l12', title: 'Shalat Isya', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ISYA}', type: 'prayer', priority: 'critical' },
          { id: 'l13', title: 'Refleksi Harian', desc: 'Evaluasi pencapaian hari ini dan rencana perbaikan', time: '20:30', type: 'mindfulness', priority: 'medium' },
          { id: 'l14', title: 'Tidur Cukup', desc: 'Target 7-8 jam tidur malam untuk kesehatan optimal', time: '22:00', type: 'health', priority: 'high' }
        ],
        short: [
          { id: 's1', title: 'Bangun Pagi', desc: 'Bangun sebelum waktu Subuh untuk persiapan sholat', time: '04:00', type: 'health', priority: 'high' },
          { id: 's2', title: 'Shalat Subuh', desc: 'Shalat berjamaah di masjid atau tepat waktu di rumah', time: '{SUBUH}', type: 'prayer', priority: 'critical' },
          { id: 's3', title: 'Sarapan Sehat', desc: 'Menu seimbang dengan protein & serat untuk energi pagi', time: '06:30', type: 'health', priority: 'medium' },
          { id: 's4', title: 'Kerja/Sekolah', desc: 'Fokus pada tanggung jawab utama dengan produktivitas tinggi', time: '08:00', type: 'work', priority: 'high' },
          { id: 's5', title: 'Shalat Dzuhur', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{DZUHUR}', type: 'prayer', priority: 'critical' },
          { id: 's6', title: 'Olahraga Ringan', desc: 'Jalan kaki, yoga, atau stretching selama 30 menit', time: '13:00', type: 'physique', priority: 'medium' },
          { id: 's7', title: 'Shalat Ashar', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ASR}', type: 'prayer', priority: 'critical' },
          { id: 's8', title: 'Kerja/Sekolah', desc: 'Lanjutkan pekerjaan penting atau tugas sekolah', time: '16:00', type: 'work', priority: 'high' },
          { id: 's9', title: 'Shalat Maghrib', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{MAGHRIB}', type: 'prayer', priority: 'critical' },
          { id: 's10', title: 'Makan Malam', desc: 'Menu sehat & porsi terkontrol, hindari makan berlebihan', time: '19:00', type: 'health', priority: 'medium' },
          { id: 's11', title: 'Shalat Isya', desc: 'Shalat berjamaah di masjid atau tepat waktu', time: '{ISYA}', type: 'prayer', priority: 'critical' },
          { id: 's12', title: 'Refleksi Harian', desc: 'Evaluasi pencapaian hari ini dan rencana perbaikan', time: '20:30', type: 'mindfulness', priority: 'medium' },
          { id: 's13', title: 'Tidur Cukup', desc: 'Target 7-8 jam tidur malam untuk kesehatan optimal', time: '22:00', type: 'health', priority: 'high' }
        ]
      };
      
      // Prayer name mappings
      const prayerNames = {
        Fajr: 'Subuh',
        Dhuhr: 'Dzuhur',
        Asr: 'Ashar',
        Maghrib: 'Maghrib',
        Isha: 'Isya',
        imsak: 'Imsak',
        sunrise: 'Matahari Terbit',
        midnight: 'Tengah Malam'
      };
      
      // Days of the week
      const daysArray = () => ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      
      // ======================
      // UTILITY FUNCTIONS
      // ======================
      
      // Format date to Indonesian locale
      function formatDate(date) {
        return date.toLocaleDateString('id-ID', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      // Parse time string to minutes
      function parseTimeToMinutes(timeStr) {
        if (!timeStr || timeStr.includes('{')) return null;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
      }
      
      // Get next date for a specific weekday
      function nextDateOfWeekday(weekday) {
        const today = new Date();
        const result = new Date(today);
        result.setDate(today.getDate() + ((7 + weekday - today.getDay()) % 7));
        result.setHours(0, 0, 0, 0);
        return result;
      }
      
      // Escape text for iCal format
      function escapeICal(str) {
        return String(str)
          .replace(/\n/g, '\\n')
          .replace(/,/g, '\\,')
          .replace(/;/g, '\\;')
          .replace(/:/g, '\\:');
      }
      
      // Convert date to iCal UTC format
      function toICalUTC(date) {
        const z = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .replace(/[-:]/g, '')
          .split('.')[0] + 'Z';
        return z;
      }
      
      // Show toast notification
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type} show`;
        toast.innerHTML = `
          <div class="toast-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '!' : '‚ÑπÔ∏è'}</div>
          <div>${message}</div>
        `;
        elements.toastContainer.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (elements.toastContainer.contains(toast)) {
              elements.toastContainer.removeChild(toast);
            }
          }, 350);
        }, 5000);
      }
      
      // Show offline indicator
      function showOfflineIndicator() {
        elements.offlineIndicator.classList.add('show');
        setTimeout(() => {
          elements.offlineIndicator.classList.remove('show');
        }, 5000);
      }
      
      // Request desktop notification permission
      function requestNotificationPermission() {
        if ('Notification' in window) {
          Notification.requestPermission();
        }
      }
      
      // Show desktop notification
      function showDesktopNotification(title, body, icon = 'üïå') {
        if ('Notification' in window && Notification.permission === 'granted') {
          try {
            new Notification(title, {
              body: body,
              icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%236d28d9'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='20' fill='white' text-anchor='middle'%3E${icon}%3C/text%3E%3C/svg%3E`,
              badge: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%236d28d9'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='20' fill='white' text-anchor='middle'%3ELU%3C/text%3E%3C/svg%3E`
            });
          } catch (e) {
            console.warn('Failed to show desktop notification:', e);
          }
        }
      }
      
      // ======================
      // LOCATION & PRAYER TIMES MODULE
      // ======================
      
      // Reverse geocoding using Nominatim
      async function reverseGeocode(lat, lon) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=id`, {
            headers: {
              'User-Agent': 'LevelUpTracker/3.0'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.address) {
            const address = data.address;
            // Prioritize city, town, village, or state
            return address.city || address.town || address.village || address.state || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
          }
          return null;
        } catch (error) {
          console.warn('Reverse geocoding failed:', error);
          return null;
        }
      }
      
      // Fetch prayer times with multiple fallbacks (enhanced with Nusantarasholat API)
      async function fetchPrayerTimes(lat, lon, city = null) {
        const originalHTML = elements.refreshTimes.innerHTML;
        elements.refreshTimes.disabled = true;
        elements.refreshIcon.innerHTML = '<span class="loading-spinner"></span>';
        
        try {
          // Try Nusantarasholat API first (Indonesian specific)
          try {
            const cityParam = city || state.settings.defaultCity || DEFAULT_FALLBACK_CITY;
            const response = await fetch(`https://api.nusantarasholat.com/v1/jadwal/${cityParam}/${new Date().getFullYear()}/${(new Date().getMonth() + 1).toString().padStart(2, '0')}/${new Date().getDate().toString().padStart(2, '0')}`);
            
            if (response.ok) {
              const data = await response.json();
              
              if (data && data.data && data.data.jadwal) {
                const jadwal = data.data.jadwal;
                state.timings = {
                  Fajr: jadwal.subuh,
                  Dhuhr: jadwal.dzuhur,
                  Asr: jadwal.ashar,
                  Maghrib: jadwal.maghrib,
                  Isha: jadwal.isya,
                  imsak: jadwal.imsak,
                  sunrise: jadwal.terbit,
                  midnight: jadwal.tengah_malam
                };
                
                // Save successful location
                state.location = { lat, lon, name: city || jadwal.lokasi || 'Lokasi Anda' };
                elements.refreshTimes.disabled = false;
                elements.refreshIcon.textContent = '‚ü≥';
                showToast('Waktu sholat berhasil dimuat dari Nusantarasholat API', 'success');
                return state.timings;
              }
            }
          } catch (nusantaraError) {
            console.warn('Nusantarasholat API failed:', nusantaraError);
          }
          
          // Fallback to Aladhan API
          try {
            const proxyUrl = 'https://corsproxy.io/?';
            const apiUrl = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`;
            
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl), {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.data && data.data.timings) {
              // Map Aladhan timings to our format
              state.timings = {
                Fajr: data.data.timings.Fajr.split(' ')[0],
                Dhuhr: data.data.timings.Dhuhr.split(' ')[0],
                Asr: data.data.timings.Asr.split(' ')[0],
                Maghrib: data.data.timings.Maghrib.split(' ')[0],
                Isha: data.data.timings.Isha.split(' ')[0],
                imsak: data.data.timings.Imsak.split(' ')[0],
                sunrise: data.data.timings.Sunrise.split(' ')[0],
                midnight: data.data.timings.Midnight.split(' ')[0]
              };
              
              // Save successful location
              state.location = { lat, lon, name: city || 'Lokasi Anda' };
              elements.refreshTimes.disabled = false;
              elements.refreshIcon.textContent = '‚ü≥';
              showToast('Waktu sholat berhasil dimuat dari Aladhan API', 'success');
              return state.timings;
            } else {
              throw new Error('Format data tidak valid');
            }
          } catch (aladhanError) {
            console.warn('Aladhan API failed:', aladhanError);
            
            // Final fallback to predefined city times
            const fallbackCity = state.settings.defaultCity || DEFAULT_FALLBACK_CITY;
            state.timings = FALLBACK_PRAYER_TIMES[fallbackCity] || FALLBACK_PRAYER_TIMES.malang;
            
            // Set location name
            if (city) {
              state.location = { lat, lon, name: city };
            } else {
              const location = fallbackCity === 'jakarta' ? JAKARTA_LOCATION : MALANG_LOCATION;
              state.location = { 
                ...location,
                name: fallbackCity.charAt(0).toUpperCase() + fallbackCity.slice(1)
              };
            }
            
            elements.refreshTimes.disabled = false;
            elements.refreshIcon.textContent = '‚ü≥';
            showToast(`Menggunakan waktu sholat fallback untuk ${state.location.name}`, 'warning');
            showOfflineIndicator();
            return state.timings;
          }
        } catch (error) {
          console.error('Fatal error fetching prayer times:', error);
          elements.locText.innerHTML = `<span class="badge badge-error">Error: ${error.message || 'Kesalahan tidak diketahui'}</span>`;
          elements.refreshTimes.disabled = false;
          elements.refreshIcon.textContent = '‚ü≥';
          showToast('Gagal memuat waktu sholat', 'error');
          return null;
        }
      }
      
      // Resolve location and prayer times with robust fallbacks
      async function resolveLocationAndTimings() {
        try {
          elements.locText.innerHTML = '<span class="loading-spinner"></span> Mendeteksi lokasi...';
          
          // Try browser geolocation first
          let position;
          let locationName = null;
          
          try {
            position = await new Promise((resolve, reject) => {
              if (!navigator.geolocation) {
                reject(new Error('Geolocation tidak didukung'));
                return;
              }
              
              navigator.geolocation.getCurrentPosition(
                resolve, 
                reject, 
                { 
                  enableHighAccuracy: true, 
                  timeout: 15000, 
                  maximumAge: 300000 // 5 minutes cache
                }
              );
            });
            
            const { latitude: lat, longitude: lon } = position.coords;
            
            // Get location name via reverse geocoding
            locationName = await reverseGeocode(lat, lon);
            
            if (locationName) {
              elements.locText.textContent = locationName;
            } else {
              elements.locText.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            }
            
            state.location = { lat, lon, name: locationName || 'Lokasi Anda' };
          } catch (geoError) {
            console.warn('Geolocation failed:', geoError);
            
            // Fallback to default city
            const fallbackCity = state.settings.defaultCity || DEFAULT_FALLBACK_CITY;
            const location = FALLBACK_PRAYER_TIMES[fallbackCity] ? 
              { lat: 0, lon: 0, name: fallbackCity.charAt(0).toUpperCase() + fallbackCity.slice(1) } : 
              MALANG_LOCATION;
            
            state.location = { ...location };
            elements.locText.textContent = `üìç ${location.name} (fallback)`;
            
            showToast('Menggunakan lokasi fallback', 'warning');
          }
          
          // Fetch prayer times
          elements.locText.innerHTML = '<span class="loading-spinner"></span> Memuat waktu sholat...';
          await fetchPrayerTimes(state.location.lat, state.location.lon, state.location.name);
          
          // Render UI
          renderPrayerTimes();
          renderTasks();
          updateNotificationBar();
        } catch (err) {
          console.error('Fatal error in location/timing resolution:', err);
          elements.locText.innerHTML = `<span class="badge badge-error">Error: ${err.message || 'Kesalahan saat memuat data'}</span>`;
          showToast('Terjadi kesalahan kritis', 'error');
        }
      }
      
      // Render prayer times in UI
      function renderPrayerTimes() {
        elements.prayerTimesGrid.innerHTML = '';
        
        if (!state.timings) {
          elements.prayerTimesGrid.innerHTML = `
            <div class="prayer-item" style="grid-column: span 5; text-align: center; padding: 20px;">
              <div class="prayer-name" style="margin-bottom: 10px;">‚ö†Ô∏è Waktu Sholat Tidak Tersedia</div>
              <div style="color: var(--text-tertiary);">Silakan perbarui lokasi</div>
            </div>
          `;
          return;
        }
        
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        // Display only main prayers + imsak
        const mainPrayers = ['imsak', 'Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        
        mainPrayers.forEach(key => {
          if (!state.timings[key]) return;
          
          const timeStr = state.timings[key];
          const prayerMinutes = parseTimeToMinutes(timeStr);
          const isCurrent = prayerMinutes && Math.abs(prayerMinutes - currentMinutes) <= 30;
          
          const item = document.createElement('div');
          item.className = `prayer-item ${isCurrent ? 'active' : ''}`;
          item.innerHTML = `
            <div class="prayer-name">${prayerNames[key] || key}</div>
            <div class="prayer-time">${timeStr}</div>
          `;
          
          if (isCurrent) {
            item.innerHTML += `<div class="badge badge-success" style="margin-top: 6px; font-size: 0.8rem;">Sedang Berlangsung</div>`;
          }
          
          elements.prayerTimesGrid.appendChild(item);
        });
      }
      
      // ======================
      // TASK MANAGEMENT MODULE
      // ======================
      
      function getScheduleForDay(dayIndex) {
        if (dayIndex === 0 || dayIndex === 6) return scheduleData.weekend;
        if (dayIndex === 2 || dayIndex === 4) return scheduleData.long;
        return scheduleData.short;
      }
      
      function replacePlaceholders(text) {
        if (!text) return '';
        if (!state.timings) return text;
        
        const replacements = {
          '{SUBUH}': state.timings.Fajr || '04:30',
          '{DZUHUR}': state.timings.Dhuhr || '12:00',
          '{ASR}': state.timings.Asr || '15:30',
          '{MAGHRIB}': state.timings.Maghrib || '18:00',
          '{ISYA}': state.timings.Isha || '19:30'
        };
        
        return Object.entries(replacements).reduce((acc, [key, value]) => 
          acc.replace(new RegExp(key, 'g'), value), text);
      }
      
      function toggleTask(taskId) {
        const dayName = daysArray()[state.selectedDay];
        const key = `${dayName}-${taskId}`;
        state.completed[key] = !state.completed[key];
        
        // Re-render tasks and update notification
        renderTasks();
        updateNotificationBar();
        
        // Show feedback
        showToast(`Tugas "${taskId}" telah ${state.completed[key] ? 'ditandai selesai' : 'dibatalkan'}`, 'success');
        
        // Show desktop notification for prayer tasks
        const task = getScheduleForDay(state.selectedDay).find(t => t.id === taskId);
        if (task && task.type === 'prayer' && state.completed[key]) {
          showDesktopNotification('Sholat Selesai', `Anda telah menyelesaikan sholat ${task.title.split(' ')[1]}`, 'üïå');
        }
      }
      
      function resetDay() {
        if (!confirm('Yakin ingin mereset semua checklist untuk hari ini?')) return;
        
        const dayName = daysArray()[state.selectedDay];
        const schedule = getScheduleForDay(state.selectedDay);
        
        schedule.forEach(task => {
          const key = `${dayName}-${task.id}`;
          delete state.completed[key];
        });
        
        renderTasks();
        updateNotificationBar();
        showToast('Checklist hari ini telah direset', 'success');
      }
      
      function completeAll() {
        if (!confirm('Yakin ingin menandai semua tugas hari ini sebagai selesai?')) return;
        
        const dayName = daysArray()[state.selectedDay];
        const schedule = getScheduleForDay(state.selectedDay);
        
        schedule.forEach(task => {
          const key = `${dayName}-${task.id}`;
          state.completed[key] = true;
        });
        
        renderTasks();
        updateNotificationBar();
        showToast('Semua tugas hari ini telah ditandai selesai', 'success');
        
        // Show desktop notification
        showDesktopNotification('Hari Produktif!', 'Anda telah menyelesaikan semua tugas hari ini', 'üéâ');
      }
      
      // ======================
      // NOTIFICATION SYSTEM MODULE
      // ======================
      
      function getNextUpcomingTask() {
        const todayIndex = new Date().getDay();
        const todaySchedule = getScheduleForDay(todayIndex);
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const dayName = daysArray()[todayIndex];
        
        // Filter uncompleted tasks and parse their times
        const upcomingTasks = todaySchedule
          .filter(task => {
            const key = `${dayName}-${task.id}`;
            return !state.completed[key];
          })
          .map(task => {
            const timeStr = replacePlaceholders(task.time);
            const taskMinutes = parseTimeToMinutes(timeStr);
            return {
              task,
              timeStr,
              taskMinutes,
              originalTime: task.time
            };
          })
          .filter(item => item.taskMinutes !== null) // Remove tasks with unparsed times
          .sort((a, b) => a.taskMinutes - b.taskMinutes); // Sort by time
        
        // Find the next task that is either:
        // 1. In the future, or
        // 2. In the past but within 30 minutes (grace period)
        for (const item of upcomingTasks) {
          const timeDiff = item.taskMinutes - currentMinutes;
          
          if (timeDiff >= -30) {
            return {
              title: item.task.title,
              time: item.timeStr,
              type: item.task.type,
              isImminent: timeDiff <= 60 && timeDiff > -15,
              isOverdue: timeDiff < 0,
              taskId: item.task.id
            };
          }
        }
        
        // If no upcoming tasks, return null
        return null;
      }
      
      function updateNotificationBar() {
        if (!state.settings.scheduleNotifications || !state.notification.visible) return;
        
        // Check if notification is snoozed
        if (state.notification.snoozedUntil) {
          const now = new Date();
          if (now < state.notification.snoozedUntil) {
            return;
          } else {
            state.notification.snoozedUntil = null;
          }
        }
        
        const nextTask = getNextUpcomingTask();
        
        if (nextTask) {
          // Show notification
          elements.mainNotification.style.display = 'flex';
          elements.mainNotification.classList.add('show');
          
          // Set urgency class
          if (nextTask.isImminent || nextTask.isOverdue) {
            elements.mainNotification.classList.add('notification-urgent');
          } else {
            elements.mainNotification.classList.remove('notification-urgent');
          }
          
          // Set text content
          if (nextTask.isOverdue) {
            elements.notificationTitle.innerHTML = `‚è∞ <strong>${nextTask.title}</strong> telah lewat!`;
          } else if (nextTask.isImminent) {
            elements.notificationTitle.innerHTML = `üîî Segera: <strong>${nextTask.title}</strong>`;
          } else {
            elements.notificationTitle.innerHTML = `Selanjutnya: <strong>${nextTask.title}</strong>`;
          }
          
          // Set time with icon
          const timeIcon = nextTask.type === 'prayer' ? 'üïå' : '‚è∞';
          elements.notificationTime.innerHTML = `${timeIcon} ${nextTask.time}`;
          
          // Update last updated time
          state.notification.lastUpdated = new Date();
          
          // Show desktop notification for imminent tasks
          if (nextTask.isImminent && (!state.notification.lastDesktopNotification || 
              new Date() - state.notification.lastDesktopNotification > 300000)) { // 5 minutes cooldown
            showDesktopNotification(
              nextTask.isOverdue ? 'Jadwal Terlewat!' : 'Jadwal Segera Dimulai',
              `${nextTask.title} akan dimulai pukul ${nextTask.time}`,
              nextTask.type === 'prayer' ? 'üïå' : '‚è∞'
            );
            state.notification.lastDesktopNotification = new Date();
          }
        } else {
          // Hide notification if no upcoming tasks
          elements.mainNotification.classList.remove('show');
          setTimeout(() => {
            elements.mainNotification.style.display = 'none';
          }, 350);
        }
      }
      
      function snoozeNotification() {
        const duration = parseInt(state.settings.snoozeDuration) || 15;
        state.notification.snoozedUntil = new Date(Date.now() + duration * 60000);
        
        elements.mainNotification.classList.remove('show');
        setTimeout(() => {
          elements.mainNotification.style.display = 'none';
        }, 350);
        
        showToast(`Notifikasi ditunda selama ${duration} menit`, 'success');
      }
      
      // ======================
      // EXPORT FUNCTIONALITY MODULE
      // ======================
      
      function makeICSForDay(dayIndex) {
        const sch = getScheduleForDay(dayIndex);
        const dayDate = nextDateOfWeekday(dayIndex);
        
        const events = sch.map(ev => {
          const timeStr = replacePlaceholders(ev.time);
          const [hh, mm] = timeStr.split(':');
          
          const start = new Date(dayDate);
          start.setHours(parseInt(hh, 10), parseInt(mm || '0', 10), 0, 0);
          
          // Set duration based on activity type
          const durationMap = {
            physique: 60,
            skill: 60,
            prayer: 15,
            work: 90,
            health: 30,
            family: 60,
            mindfulness: 30,
            planning: 30,
            other: 30
          };
          
          const duration = durationMap[ev.type] || 45;
          const end = new Date(start.getTime() + duration * 60000);
          
          return {
            ...ev,
            start,
            end,
            uid: `lvlup-${dayIndex}-${ev.id}@levelup.tracker`,
            timeStr
          };
        });
        
        // Build ICS content
        let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//LevelUp Tracker//EN\r\nCALSCALE:GREGORIAN\r\n';
        ics += 'X-WR-CALNAME:LevelUp Tracker\r\nX-WR-TIMEZONE:Asia/Jakarta\r\n';
        
        events.forEach(e => {
          ics += 'BEGIN:VEVENT\r\n';
          ics += `UID:${e.uid}\r\n`;
          ics += `SUMMARY:${escapeICal(e.title)}\r\n`;
          ics += `DESCRIPTION:${escapeICal(replacePlaceholders(e.desc))}\r\n`;
          ics += `DTSTART:${toICalUTC(e.start)}\r\n`;
          ics += `DTEND:${toICalUTC(e.end)}\r\n`;
          ics += 'CLASS:PUBLIC\r\n';
          ics += 'PRIORITY:5\r\n';
          ics += 'STATUS:CONFIRMED\r\n';
          ics += 'TRANSP:OPAQUE\r\n';
          ics += 'END:VEVENT\r\n';
        });
        
        ics += 'END:VCALENDAR\r\n';
        return ics;
      }
      
      function exportICSForSelectedDay() {
        const ics = makeICSForDay(state.selectedDay);
        const dayName = daysArray()[state.selectedDay];
        const filename = `levelup-${dayName.toLowerCase()}-${new Date().toISOString().slice(0,10)}.ics`;
        
        const blob = new Blob([ics], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('File ICS berhasil diunduh!', 'success');
        
        // Show feedback on button
        const originalText = elements.exportICS.innerHTML;
        elements.exportICS.innerHTML = '<span>‚úì</span> Berhasil!';
        elements.exportICS.style.background = 'linear-gradient(90deg, var(--accent-emerald), var(--accent-blue))';
        
        setTimeout(() => {
          elements.exportICS.innerHTML = originalText;
          elements.exportICS.style.background = '';
        }, 2000);
      }
      
      function generateCSV30() {
        // Header
        const header = ['tanggal,sekolah(Y/N),shalat_lengkap(Y/N),jam_skill(jam),jam_olahraga,jumlah_project_done,catatan'];
        const rows = [];
        const start = new Date();
        start.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 30; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);
          const weekday = d.getDay();
          const isSchool = !(weekday === 0 || weekday === 6);
          const dateStr = d.toISOString().slice(0, 10);
          rows.push([dateStr, isSchool ? 'Y' : 'N', '', '0', '', '', '']);
        }
        
        const csv = header.concat(rows.map(r => r.join(','))).join('\n');
        const filename = `levelup-habit-tracker-${new Date().toISOString().slice(0,10)}.csv`;
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('File CSV berhasil diunduh!', 'success');
        
        // Show feedback on button
        const originalText = elements.downloadCSV.innerHTML;
        elements.downloadCSV.innerHTML = '<span>‚úì</span> Berhasil!';
        elements.downloadCSV.style.background = 'linear-gradient(90deg, var(--accent-emerald), var(--accent-blue))';
        
        setTimeout(() => {
          elements.downloadCSV.innerHTML = originalText;
          elements.downloadCSV.style.background = '';
        }, 2000);
      }
      
      // ======================
      // UI RENDERING MODULE
      // ======================
      
      function renderDays() {
        elements.days.innerHTML = '';
        const today = new Date().getDay();
        
        daysArray().forEach((day, index) => {
          const btn = document.createElement('button');
          btn.className = `day-btn ${state.selectedDay === index ? 'active' : ''} ${index === today ? 'today' : ''}`;
          btn.innerHTML = `
            <span>${day}</span>
            ${index === today ? '<small>Hari Ini</small>' : ''}
          `;
          btn.setAttribute('role', 'tab');
          btn.setAttribute('aria-selected', state.selectedDay === index);
          btn.onclick = () => {
            state.selectedDay = index;
            renderTasks();
            updateNotificationBar();
          };
          elements.days.appendChild(btn);
        });
      }
      
      function renderTasks() {
        elements.tasksList.innerHTML = '';
        
        const schedule = getScheduleForDay(state.selectedDay);
        elements.totalCount.textContent = schedule.length;
        
        // Update current date display
        const today = new Date();
        elements.currentDate.textContent = formatDate(today);
        
        const dayName = daysArray()[state.selectedDay];
        let done = 0;
        
        // Get current time for status badges
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        
        schedule.forEach(item => {
          const key = `${dayName}-${item.id}`;
          const doneFlag = !!state.completed[key];
          if (doneFlag) done++;
          
          const taskCard = document.createElement('div');
          taskCard.className = `task-card ${doneFlag ? 'completed' : ''}`;
          taskCard.setAttribute('role', 'button');
          taskCard.setAttribute('tabindex', '0');
          taskCard.onclick = () => openTaskModal(item, key);
          
          // Determine task status for badge
          const taskTimeStr = replacePlaceholders(item.time);
          const taskTimeMinutes = parseTimeToMinutes(taskTimeStr);
          let statusBadge = '';
          let statusClass = '';
          
          if (!doneFlag && taskTimeMinutes !== null) {
            const timeDiff = taskTimeMinutes - currentTimeInMinutes;
            
            if (timeDiff < -30) {
              statusBadge = '<div class="task-status status-overdue">Terlewat</div>';
              statusClass = 'status-overdue';
            } else if (timeDiff < 0) {
              statusBadge = '<div class="task-status status-due">Segera</div>';
              statusClass = 'status-due';
            } else if (timeDiff < 60) {
              statusBadge = '<div class="task-status status-upcoming">Segera</div>';
              statusClass = 'status-upcoming';
            }
          } else if (doneFlag) {
            statusBadge = '<div class="task-status status-completed">Selesai</div>';
            statusClass = 'status-completed';
          }
          
          // Determine icon based on task type
          let iconContent = '‚úì';
          let iconClass = 'task-icon default';
          
          switch(item.type) {
            case 'prayer':
              iconContent = 'üïå';
              iconClass = 'task-icon prayer';
              break;
            case 'skill':
              iconContent = 'üß†';
              iconClass = 'task-icon skill';
              break;
            case 'physique':
              iconContent = 'üí™';
              iconClass = 'task-icon physique';
              break;
            case 'health':
              iconContent = 'ü•ó';
              iconClass = 'task-icon health';
              break;
            case 'work':
              iconContent = 'üíº';
              iconClass = 'task-icon work';
              break;
            case 'family':
              iconContent = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
              iconClass = 'task-icon family';
              break;
            case 'mindfulness':
              iconContent = 'üßò';
              iconClass = 'task-icon default';
              break;
            default:
              iconContent = '‚úì';
              iconClass = 'task-icon default';
          }
          
          if (doneFlag) {
            iconContent = '‚úì';
            iconClass = 'task-icon default';
          }
          
          // Priority indicator
          let priorityBadge = '';
          if (item.priority === 'critical') {
            priorityBadge = '<div class="badge badge-error" style="margin-top: 4px; font-size: 0.75rem;">KRITIS</div>';
          } else if (item.priority === 'high') {
            priorityBadge = '<div class="badge badge-warning" style="margin-top: 4px; font-size: 0.75rem;">PENTING</div>';
          }
          
          taskCard.innerHTML = `
            <div class="${iconClass}">${iconContent}</div>
            <div class="task-content">
              <div class="task-header">
                <div class="task-title">${item.title}</div>
                <div class="task-time">${taskTimeStr.includes('{') ? item.time : taskTimeStr}</div>
              </div>
              <div class="task-desc">${replacePlaceholders(item.desc)}</div>
              ${statusBadge}
              ${priorityBadge}
            </div>
            <div class="task-actions">
              <button class="task-btn ${doneFlag ? '' : 'complete'}" data-task-id="${item.id}">
                ${doneFlag ? '‚úì Selesai' : 'Tandai Selesai'}
              </button>
            </div>
          `;
          
          // Add event listener to the button
          const completeBtn = taskCard.querySelector('.task-btn');
          completeBtn.onclick = (e) => {
            e.stopPropagation();
            toggleTask(item.id);
          };
          
          elements.tasksList.appendChild(taskCard);
        });
        
        elements.doneCount.textContent = done;
        const percent = Math.round(done / Math.max(1, schedule.length) * 100);
        elements.score.textContent = percent + '%';
        elements.progressBar.style.width = percent + '%';
      }
      
      function openTaskModal(task, key) {
        state.currentTaskId = task.id;
        
        elements.modalTaskTitle.textContent = task.title;
        elements.modalTaskDesc.textContent = replacePlaceholders(task.desc);
        elements.modalTaskTime.textContent = replacePlaceholders(task.time);
        
        // Set category with icon
        let categoryText = '';
        switch(task.type) {
          case 'prayer': categoryText = 'üïå Ibadah'; break;
          case 'skill': categoryText = 'üß† Pengembangan Diri'; break;
          case 'physique': categoryText = 'üí™ Kesehatan Fisik'; break;
          case 'health': categoryText = 'ü•ó Gaya Hidup Sehat'; break;
          case 'work': categoryText = 'üíº Pekerjaan/Sekolah'; break;
          case 'family': categoryText = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Keluarga'; break;
          case 'mindfulness': categoryText = 'üßò Refleksi Diri'; break;
          case 'planning': categoryText = 'üìù Perencanaan'; break;
          default: categoryText = '‚úì Lainnya';
        }
        elements.modalTaskCategory.textContent = categoryText;
        
        // Set status
        const isCompleted = !!state.completed[key];
        elements.modalTaskStatus.className = 'task-status';
        elements.modalTaskStatus.textContent = isCompleted ? 'Selesai' : 'Belum Selesai';
        elements.modalTaskStatus.classList.add(isCompleted ? 'status-completed' : 'status-upcoming');
        
        // Show modal
        elements.taskDetailModal.classList.add('show');
      }
      
      function closeTaskModal() {
        elements.taskDetailModal.classList.remove('show');
        state.currentTaskId = null;
      }
      
      // ======================
      // CHART RENDERING MODULE
      // ======================
      
      function renderWeeklyChart() {
        const ctx = document.getElementById('weeklyChart');
        if (!ctx) return;
        
        // Simple bar chart rendering (in a real app, we'd use Chart.js)
        ctx.innerHTML = `
          <div style="display: flex; align-items: flex-end; height: 100%; gap: 8px; padding: 10px;">
            ${state.weeklyData.map(item => `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div style="height: ${item.progress}%; width: 100%; background: linear-gradient(to top, var(--accent-indigo), var(--accent-violet)); border-radius: 4px 4px 0 0;"></div>
                <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);">${item.day.substring(0, 3)}</div>
                <div style="font-weight: 600; font-size: 0.9rem; margin-top: 4px;">${item.progress}%</div>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      // ======================
      // SEARCH & FILTER MODULE
      // ======================
      
      function setupSearch() {
        elements.taskSearch.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const taskCards = document.querySelectorAll('.task-card');
          
          taskCards.forEach(card => {
            const title = card.querySelector('.task-title').textContent.toLowerCase();
            const desc = card.querySelector('.task-desc').textContent.toLowerCase();
            
            if (title.includes(searchTerm) || desc.includes(searchTerm)) {
              card.style.display = 'flex';
            } else {
              card.style.display = 'none';
            }
          });
        });
      }
      
      // ======================
      // TABS MODULE
      // ======================
      
      function setupTabs() {
        elements.tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            // Remove active class from all tabs
            elements.tabBtns.forEach(b => b.classList.remove('active'));
            
            // Add active class to clicked tab
            btn.classList.add('active');
            
            // Show corresponding tab content (in a real app, we'd load different content)
            if (btn.dataset.tab === 'today') {
              // Already showing today's tasks
            } else if (btn.dataset.tab === 'week') {
              showToast('Menampilkan ringkasan minggu ini', 'info');
            } else if (btn.dataset.tab === 'history') {
              showToast('Menampilkan riwayat tugas', 'info');
            }
          });
        });
      }
      
      // ======================
      // SETTINGS MODULE
      // ======================
      
      function loadSettings() {
        // Load from localStorage if available
        const savedSettings = localStorage.getItem('levelupSettings');
        if (savedSettings) {
          Object.assign(state.settings, JSON.parse(savedSettings));
        }
        
        // Apply settings to UI
        elements.prayerNotificationToggle.checked = state.settings.prayerNotifications;
        elements.taskNotificationToggle.checked = state.settings.taskNotifications;
        elements.snoozeDuration.value = state.settings.snoozeDuration;
        elements.darkModeToggle.checked = state.settings.darkMode;
        elements.citySelect.value = state.settings.defaultCity;
      }
      
      function saveSettings() {
        localStorage.setItem('levelupSettings', JSON.stringify(state.settings));
      }
      
      function setupSettingsListeners() {
        elements.prayerNotificationToggle.addEventListener('change', (e) => {
          state.settings.prayerNotifications = e.target.checked;
          saveSettings();
        });
        
        elements.taskNotificationToggle.addEventListener('change', (e) => {
          state.settings.taskNotifications = e.target.checked;
          saveSettings();
        });
        
        elements.snoozeDuration.addEventListener('change', (e) => {
          state.settings.snoozeDuration = e.target.value;
          saveSettings();
        });
        
        elements.darkModeToggle.addEventListener('change', (e) => {
          state.settings.darkMode = e.target.checked;
          saveSettings();
          // In a real app, we'd toggle dark mode styles
        });
        
        elements.citySelect.addEventListener('change', (e) => {
          state.settings.defaultCity = e.target.value;
          saveSettings();
          // Reload prayer times with new city
          showToast(`Menggunakan kota ${e.target.options[e.target.selectedIndex].text} untuk waktu sholat`, 'info');
          resolveLocationAndTimings();
        });
      }
      
      // ======================
      // INITIALIZATION
      // ======================
      
      function init() {
        // Load settings
        loadSettings();
        
        // Render initial UI (with skeleton loaders)
        renderDays();
        renderTasks();
        renderWeeklyChart();
        
        // Request notification permission
        requestNotificationPermission();
        
        // Set up notification system
        updateNotificationBar();
        setInterval(updateNotificationBar, 60000); // Update every minute
        
        // Get location and prayer times
        resolveLocationAndTimings();
        
        // Set up event listeners
        elements.refreshTimes.addEventListener('click', resolveLocationAndTimings);
        elements.exportICS.addEventListener('click', exportICSForSelectedDay);
        elements.downloadCSV.addEventListener('click', generateCSV30);
        elements.resetDay.addEventListener('click', resetDay);
        elements.completeAll.addEventListener('click', completeAll);
        
        // Notification bar controls
        elements.notificationClose.addEventListener('click', () => {
          elements.mainNotification.classList.remove('show');
          setTimeout(() => {
            elements.mainNotification.style.display = 'none';
          }, 350);
          state.notification.visible = false;
        });
        
        document.querySelector('.notification-btn.complete').addEventListener('click', () => {
          const nextTask = getNextUpcomingTask();
          if (nextTask) {
            toggleTask(nextTask.taskId);
          }
        });
        
        document.querySelector('.notification-btn.snooze').addEventListener('click', snoozeNotification);
        
        // Modal controls
        elements.closeModal.addEventListener('click', closeTaskModal);
        elements.closeModalBtn.addEventListener('click', closeTaskModal);
        elements.completeTaskBtn.addEventListener('click', () => {
          if (state.currentTaskId) {
            toggleTask(state.currentTaskId);
            closeTaskModal();
          }
        });
        
        // Settings listeners
        setupSettingsListeners();
        
        // Search and tabs
        setupSearch();
        setupTabs();
        
        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeTaskModal();
          }
          
          if (e.key === ' ' || e.key === 'Enter') {
            const activeEl = document.activeElement;
            if (activeEl && activeEl.classList.contains('task-card')) {
              activeEl.click();
              e.preventDefault();
            }
          }
        });
        
        // Add offline detection
        window.addEventListener('offline', () => {
          showOfflineIndicator();
        });
        
        // Remove skeleton loaders after initial render
        setTimeout(() => {
          document.querySelectorAll('.skeleton').forEach(el => {
            el.style.opacity = '0';
            setTimeout(() => {
              el.remove();
            }, 300);
          });
          
          // Add fade-in animation to content
          document.querySelectorAll('.fade-in').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(10px)';
            setTimeout(() => {
              el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
              el.style.opacity = '1';
              el.style.transform = 'translateY(0)';
            }, 100);
          });
        }, 800);
      }
      
      // Public API
      return {
        init: init,
        showToast: showToast,
        showDesktopNotification: showDesktopNotification
      };
    })();
    
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      LevelUpTracker.init();
      
      // Show welcome message on first visit
      if (!localStorage.getItem('levelupFirstVisit')) {
        LevelUpTracker.showToast('Selamat datang di LevelUp Tracker! Aplikasi ini membantu Anda mengintegrasikan jadwal sholat dengan produktivitas harian.', 'success');
        localStorage.setItem('levelupFirstVisit', 'true');
      }
    });
  </script>
</body>
</html>

